#!/bin/sh

bindir=@bindir@
datadir=@datadir@

LOWER='abcdefghijklmnopqrstuvwxyz'
UPPER='ABCDEFGHIJKLMNOPQRSTUVWXYZ'

EXPLANG="$1"
shift
IMPLANG="`echo $LANG | sed "s/...\(..\).*/\1/;y/$UPPER/$LOWER/"`"

if [ -n "$EXPLANG" ]; then
	LANGUAGE="$EXPLANG"
	if [ -n "$LANGUAGES" ]; then
		LANGUAGES="$EXPLAN,$LANGUAGES"
	else
		LANGUAGES="$EXPLAN"
	fi
	export LANGUAGES
else
	LANGUAGE="$IMPLANG"
fi

function isconsole() {
	if [ 0 "<" $(expr "`tty`" : "/dev/tty[0-9]") ]
	then return 0; else return 1; fi
}

function iskbdunicode() {
	if kbd_mode | grep -q -i Unicode
	then return 0; else return 1; fi
}


# setup environment (bicon_start)
case "$TERM" in

	linux)
		if isconsole; then
			# save old keyboard state
			iskbdunicode &&
			WAS_UNICODE=true || WAS_UNICODE=false
			if [ "x$WAS_UNICODE" = xfalse ]; then
				kbd_mode -u
				echo -ne '\033%G'
			fi
			OLD_KBD=`dumpkeys`

			# set keymap
			loadkeys "${datadir}/keymap/$LANGUAGE.map.gz" 2>/dev/null ||
			loadkeys "$LANGUAGE"

			# set font
			setfont "${datadir}/font/bicon-8x16-512.psfu.gz"
		fi
	;;

	xterm)
		if [ -n "$DISPLAY" ]; then
			# only load keymap if asked explicitly
			if [ -n "$EXPLANG" ]; then

				# save old keyboard state
				OLD_XKB="`setxkbmap \
					-display "$DISPLAY" \
					-print`"

				# set keymap
				# better heuristic wanted
				setxkbmap \
					-display "$DISPLAY" \
					-layout "us,$EXPLANG" \
					-option grp:alt_shift_toggle,grp_led:scroll \
					-print | \
				xkbcomp -w 2 - "$DISPLAY"
			fi

			# set font
			# guess there's no way to do
		fi
	;;

	*)

	;;

esac


echo "BiCon started"
# do the real thing
${bindir}/bicon.bin "$@"
STATUS=$?
echo "BiCon done"


# rollback environment (bicon_stop)
case "$TERM" in

	linux)
		if isconsole; then
			# default font
			setfont

			# default keymap
			#loadkeys -d

			# or

			# load old keymap
			if [ -n "$OLD_KBD" ]; then
				echo "$OLD_KBD" | loadkeys
				unset OLD_KBD
			fi


			# load old keyboard state
			if [ "x$WAS_UNICODE" = "xtrue" -a ! iskbdunicode ]; then
				dumpkeys | loadkeys -u
			else
				kbd_mode -a
				echo -ne '\033%@'
			fi
			unset WAS_UNICODE
		fi
	;;

	xterm)
		if [ -n "$DISPLAY" ]; then
			
			# load old keyboard state and keymap
			if [ -n "$OLD_XKB" ]; then

				echo "$OLD_XKB" | xkbcomp -w 2 - "$DISPLAY"
				unset "OLD_XKB"
			fi
		fi
	;;

	*)

	;;

esac

exit $STATUS
